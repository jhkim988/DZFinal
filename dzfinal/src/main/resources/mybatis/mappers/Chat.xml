<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.douzone.dzfinal.repository.ChatRepository">
	<resultMap id="chatListMap" type="com.douzone.dzfinal.dto.ChatDTO$ChatRoom">
	  <id property="chatroom_id" column="chatroom_id"/>
	  <result property="chatroom_name" column="chatroom_name"/>
	  <collection property="employee_names" ofType="java.lang.String">
	    <result column="employee_names"/>
	  </collection>
	</resultMap>
	
	<select id="chatRoomList" resultMap="chatListMap">
	  SELECT cr.chatroom_id, cr.chatroom_name, GROUP_CONCAT(e.employee_name SEPARATOR ', ') as employee_names
	  FROM ChatRoom_Participants crp
	  	JOIN ChatRoom cr ON crp.chatroom_id = cr.chatroom_id
	  	JOIN Employee e ON crp.participants_id = e.employ_id AND crp.participants_id != #{participants_id}
	  WHERE crp.chatroom_id IN (
	      SELECT chatroom_id 
	      FROM ChatRoom_Participants 
	      WHERE participants_id = #{participants_id}
	  )
	  GROUP BY cr.chatroom_id, cr.chatroom_name;
	</select>
	
	<select id="getChatRoomMessages" resultType="com.douzone.dzfinal.dto.ChatDTO$Message">
		SELECT chatroom_id, message, created_at, c.from, employee_name, thumbnail_image
		FROM Chat c INNER JOIN Employee e on c.from = e.employ_id
		WHERE chatroom_id = #{chatroom_id}
	</select>
	
	<insert id="insert">
		INSERT INTO Chat(chatroom_id, message, created_at, `from`) VALUES (#{chatroom_id}, #{message}, now(), #{from});
	</insert>
</mapper>