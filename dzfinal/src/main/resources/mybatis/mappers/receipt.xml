<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.douzone.dzfinal.repository.ReceiptRepository">
	<resultMap type="com.douzone.dzfinal.entity.Reception" id="receiptMap">
		<id property="reception_id" column="reception_id"/>
		<result property="doctor" column="doctor"/>
		<result property="treatment_reason" column="treatment_reason"/>
		<result property="patient_id" column="patient_id"/>
		<result property="creator" column="creator"/>
		<result property="updator" column="updator"/>
		<result property="created_at" column="created_at"/>
		<result property="updated_at" column="updated_at"/>
		<result property="state" column="state"/>
		<result property="systolic" column="systolic"/>
		<result property="diastolic" column="diastolic"/>
		<result property="blood_sugar" column="blood_sugar"/>
		<result property="height" column="height"/>
		<result property="weight" column="weight"/>
		<result property="bmi" column="bmi"/>
		<result property="is_deleted" column="is_deleted"/>
		<association property="patient" javaType="com.douzone.dzfinal.entity.Patient">
			<id property="patient_id" column="patient_id"/>
			<result property="patient_name" column="patient_name"/>
			<result property="phone_number1" column="phone_number1"/>
			<result property="phone_number2" column="phone_number2"/>
			<result property="phone_number3" column="phone_number3"/>
			<result property="front_registration_number" column="front_registration_number"/>
			<result property="back_registration_number" column="back_registration_number"/>
			<result property="gender" column="gender"/>
			<result property="zip_code" column="zip_code"/>
			<result property="address" column="address"/>
			<result property="detail_address" column="detail_address"/>
			<result property="insurance" column="insurance"/>
			<result property="creator" column="creator"/>
			<result property="updator" column="updator"/>
			<result property="created_at" column="created_at"/>
			<result property="updated_at" column="updated_at"/>
			<result property="is_deleted" column="is_deleted"/>
		</association>
		<association property="clinic" javaType="com.douzone.dzfinal.entity.Clinic">
			<id property="clinic_id" column="clinic_id" />
			<result property="reception_id" column="reception_id" />
			<result property="symptom" column="symptom" />
			<result property="treatment" column="treatment" />
			<result property="clinic_request" column="clinic_request" />
			<result property="creator" column="creator" />
			<result property="updator" column="updator" />
			<result property="created_at" column="created_at" />
			<result property="updated_at" column="updated_at" />
		</association>
	</resultMap>
	
	
	<!-- 수납할 사람 데이터 가져오기 -->
 	<select id="findOneByReception" resultType="com.douzone.dzfinal.dto.ReceiptDTO$ReceptionInfo">
		SELECT
	               r.reception_id       		reception_id,
	               r.doctor						doctor,
	               
	               p.patient_id       			patient_id,
	               p.patient_name      			patient_name,
	               p.insurance       			insurance,
	               p.gender						gender,
	               p.front_registration_number	front_registration_number,
	               p.back_registration_number	back_registration_number,
	               p.address					address,
	               p.detail_address				detail_address,
	               
	               c.treatment       			treatment,
	               c.clinic_request    			clinic_request,
	               (SELECT IF (COUNT(*) > 0, 1, 0) FROM Prescription pr WHERE pr.reception_id = 1) has_prescription
	      FROM       	Reception r 
	      INNER JOIN    Patient p ON r.patient_id = p.patient_id
	      INNER JOIN    Clinic c  ON r.reception_id = c.reception_id
	      WHERE       	r.reception_id = #{reception_id};
	</select>
	
	<select id="selectReceiptDetail" resultType="hashmap">
		SELECT
	               r.reception_id       		reception_id,
	               r.doctor						doctor,
	               
	               p.patient_id       			patient_id,
	               p.patient_name      			patient_name,
	               p.insurance       			insurance,
	               p.gender						gender,
	               p.front_registration_number	front_registration_number,
	               p.back_registration_number	back_registration_number,
	               p.address					address,
	               p.detail_address				detail_address,
	               
	               c.treatment       			treatment,
	               c.clinic_request    			clinic_request,
	               		(SELECT IF (COUNT(*) > 0, 1, 0) 
	               		FROM 	Prescription pr
	               		WHERE 	pr.reception_id = 3) has_prescription
	     FROM       	Reception r 
	     INNER JOIN    Patient p ON r.patient_id = p.patient_id
	     INNER JOIN    Clinic c  ON r.reception_id = c.reception_id
	     WHERE       	r.reception_id = 2;
	</select>
	
	
	
	
	
	<!-- 수납완료! -->
	<select id="insertReceipt" parameterType="Receipt" resultType="hashmap">
		insert into Receipt(
								reception_id, 
								ratio, 
								total_amount, 
								card_name, 
								card_number, 
								mode, 
								creator
								)
			values(
					#{reception_id}, 
					#{ratio}, 
					#{total_amount}, 
					#{card_name}, 
					#{card_number}, 
					#{mode}, 
					1
					)
	</select>
	




	<!-- 처방전 정보 가져오기! -->
	<select id="getTreatmentInfo" resultType="com.douzone.dzfinal.dto.ReceiptDTO$TreatmentInfo">
		SELECT 
			ds.disease_code 				disease_code,
			ds.disease_name 				disease_name,
			
			dr.drug_code 					drug_code,
			dr.drug_name 					drug_name,
			
			d.created_at 					created_at
		FROM 		Reception r
		INNER JOIN 	Diagnosis d 	  ON r.reception_id = d.reception_id
		INNER JOIN 	Disease ds 		  ON d.disease_id = ds.disease_id 
		INNER JOIN 	Prescription pr   ON r.reception_id = pr.reception_id
		INNER JOIN 	Drug dr 		  ON pr.drug_id =dr.drug_id
		WHERE 		r.reception_id = #{reception_id};
	</select>
	
	
	<select id="getTreatment" resultType="hashmap">
		SELECT 
			ds.disease_code 				disease_code,
			ds.disease_name 				disease_name,
			
			dr.drug_code 					drug_code,
			dr.drug_name 					drug_name,
			
			d.created_at 					created_at
		FROM 		Reception r
		INNER JOIN 	Diagnosis d 	  ON r.reception_id = d.reception_id
		INNER JOIN 	Disease ds 		  ON d.disease_id = ds.disease_id 
		INNER JOIN 	Prescription pr   ON r.reception_id = pr.reception_id
		INNER JOIN 	Drug dr 		  ON pr.drug_id =dr.drug_id
		WHERE 		r.reception_id = 2;
	</select>
	
	
	
	
	
	
	
	
	<!-- 진료의뢰서 정보 가져오기! -->
	<select id="getClinicRequestInfo" resultType="com.douzone.dzfinal.dto.ReceiptDTO$ClinicRequestInfo">
		SELECT 
			ds.disease_code 				disease_code,
			ds.disease_name 				disease_name,
			
			dr.drug_code 					drug_code,
			dr.drug_name 					drug_name,
			
			d.created_at 					created_at
		FROM 		Reception r
		INNER JOIN 	Diagnosis d 	  ON r.reception_id = d.reception_id
		INNER JOIN 	Disease ds 		  ON d.disease_id = ds.disease_id 
		INNER JOIN 	Prescription pr   ON r.reception_id = pr.reception_id
		INNER JOIN 	Drug dr 		  ON pr.drug_id =dr.drug_id
		WHERE 		r.patient_id = #{patient_id};
	</select>
	
	
	<select id="getClinicRequest" resultType="hashmap">
		SELECT 
			ds.disease_code 				disease_code,
			ds.disease_name 				disease_name,
			
			dr.drug_code 					drug_code,
			dr.drug_name 					drug_name,
			
			d.created_at 					created_at
		FROM 		Reception r
		INNER JOIN 	Diagnosis d 	  ON r.reception_id = d.reception_id
		INNER JOIN 	Disease ds 		  ON d.disease_id = ds.disease_id 
		INNER JOIN 	Prescription pr   ON r.reception_id = pr.reception_id
		INNER JOIN 	Drug dr 		  ON pr.drug_id =dr.drug_id
		WHERE 		r.patient_id = 2;
	</select>


	


	<!-- 수납완료내역 정보 가져오기! -->
	<select id="getReceiptList" resultType="com.douzone.dzfinal.dto.ReceiptDTO$GetReceiptList">
		SELECT 
			r.reception_id       			reception_id,
			r.doctor 						doctor,
			p.patient_id       				patient_id,
			p.patient_name      			patient_name,
			p.front_registration_number 	front_registration_number,
			p.phone_number3 				phone_number3,
			ds.disease_name 				disease_name,
			dr.drug_name 					drug_name,
			rt.total_amount 				total_amount,
			rt.mode 						mode,
			rt.created_at 					created_at 
		FROM 		Reception r
		 LEFT JOIN 	Patient p 		  ON r.patient_id = p.patient_id
		 LEFT JOIN 	Diagnosis d 	  ON r.reception_id = d.reception_id
		 LEFT JOIN 	Disease ds 		  ON d.disease_id = ds.disease_id
		 LEFT JOIN 	Prescription pr   ON r.reception_id = pr.reception_id
		 LEFT JOIN 	Drug dr 		  ON pr.drug_id =dr.drug_id
		 LEFT JOIN  Receipt rt 		  ON r.reception_id = rt.reception_id
		WHERE 		r.patient_id = #{patient_id};
	</select>
	
	<select id="getReceipt" resultType="hashmap">
		SELECT 
			r.reception_id       			reception_id,
			r.doctor 						doctor,
			p.patient_id       				patient_id,
			p.patient_name      			patient_name,
			p.front_registration_number 	front_registration_number,
			p.phone_number3 				phone_number3,
			ds.disease_name 				disease_name,
			dr.drug_name 					drug_name,
			rt.total_amount 				total_amount,
			rt.mode 						mode,
			rt.created_at 					created_at 
		FROM 		Reception r
		 LEFT JOIN 	Patient p 		  ON r.patient_id = p.patient_id
		 LEFT JOIN 	Diagnosis d 	  ON r.reception_id = d.reception_id
		 LEFT JOIN 	Disease ds 		  ON d.disease_id = ds.disease_id
		 LEFT JOIN 	Prescription pr   ON r.reception_id = pr.reception_id
		 LEFT JOIN 	Drug dr 		  ON pr.drug_id =dr.drug_id
		 LEFT JOIN  Receipt rt 		  ON r.reception_id = rt.reception_id
		WHERE 		r.patient_id = 2;
	</select>

</mapper>