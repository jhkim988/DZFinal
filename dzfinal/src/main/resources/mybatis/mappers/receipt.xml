<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.douzone.dzfinal.repository.ReceiptRepository">
	<resultMap type="com.douzone.dzfinal.entity.Reception" id="receiptMap">
		<id property="reception_id" column="reception_id"/>
		<result property="doctor" column="doctor"/>
		<result property="treatment_reason" column="treatment_reason"/>
		<result property="patient_id" column="patient_id"/>
		<result property="creator" column="creator"/>
		<result property="updator" column="updator"/>
		<result property="created_at" column="created_at"/>
		<result property="updated_at" column="updated_at"/>
		<result property="state" column="state"/>
		<result property="systolic" column="systolic"/>
		<result property="diastolic" column="diastolic"/>
		<result property="blood_sugar" column="blood_sugar"/>
		<result property="height" column="height"/>
		<result property="weight" column="weight"/>
		<result property="bmi" column="bmi"/>
		<result property="is_deleted" column="is_deleted"/>
		<association property="patient" javaType="com.douzone.dzfinal.entity.Patient">
			<id property="patient_id" column="patient_id"/>
			<result property="patient_name" column="patient_name"/>
			<result property="phone_number1" column="phone_number1"/>
			<result property="phone_number2" column="phone_number2"/>
			<result property="phone_number3" column="phone_number3"/>
			<result property="front_registration_number" column="front_registration_number"/>
			<result property="back_registration_number" column="back_registration_number"/>
			<result property="gender" column="gender"/>
			<result property="zip_code" column="zip_code"/>
			<result property="address" column="address"/>
			<result property="detail_address" column="detail_address"/>
			<result property="insurance" column="insurance"/>
			<result property="creator" column="creator"/>
			<result property="updator" column="updator"/>
			<result property="created_at" column="created_at"/>
			<result property="updated_at" column="updated_at"/>
			<result property="is_deleted" column="is_deleted"/>
		</association>
		<association property="clinic" javaType="com.douzone.dzfinal.entity.Clinic">
			<id property="clinic_id" column="clinic_id" />
			<result property="reception_id" column="reception_id" />
			<result property="symptom" column="symptom" />
			<result property="treatment" column="treatment" />
			<result property="clinic_request" column="clinic_request" />
			<result property="creator" column="creator" />
			<result property="updator" column="updator" />
			<result property="created_at" column="created_at" />
			<result property="updated_at" column="updated_at" />
		</association>
	</resultMap>
	
	
	
 	<select id="findOneByReception" resultType="com.douzone.dzfinal.dto.ReceiptDTO$ReceptionInfo">
		 SELECT
	               r.reception_id       reception_id,
	               p.patient_id       	patient_id,
	               p.patient_name      	patient_name,
	               p.insurance       	insurance,
	               c.treatment       	treatment,
	               c.clinic_request    	clinic_request,
	               		(SELECT IF (COUNT(*) > 0, 1, 0) 
	               		FROM 	Prescription pr
	               		WHERE 	pr.reception_id = #{reception_id}) has_prescription
	     FROM       	Reception r 
	     INNER JOIN    Patient p ON r.patient_id = p.patient_id
	     INNER JOIN    Clinic c  ON r.reception_id = c.reception_id
	     WHERE       	r.reception_id = #{reception_id};
	</select>
	
		<select id="selectReceiptDetail" resultType="hashmap">
		SELECT
	               r.reception_id       reception_id,
	               p.patient_id       	patient_id,
	               p.patient_name      	patient_name,
	               p.insurance       	insurance,
	               c.treatment       	treatment,
	               c.clinic_request    	clinic_request,
	               		(SELECT IF (COUNT(*) > 0, 1, 0) 
	               		FROM 	Prescription pr
	               		WHERE 	pr.reception_id = 2) has_prescription
	     FROM       	Reception r 
	     INNER JOIN    Patient p ON r.patient_id = p.patient_id
	     INNER JOIN    Clinic c  ON r.reception_id = c.reception_id
	     WHERE       	r.reception_id = 2;
	</select>
	
	
	
	<select id="insertReceipt" parameterType="Receipt" resultType="hashmap">
		insert into Receipt(
								reception_id, 
								ratio, 
								total_amount, 
								card_name, 
								card_number, 
								mode, 
								creator
								)
			values(
					#{reception_id}, 
					#{ratio}, 
					#{total_amount}, 
					#{card_name}, 
					#{card_number}, 
					#{mode}, 
					1
					)
	</select>
	


	
	<select id="receiptList" resultType="Receipt">
		SELECT
			r.receipt_id,
			r.reception_id,
			r.ratio,
			r.total_amount,
			r.card_name,
			r.card_number,
			r.mode,
			r.creator,
			r.created_at,
			r2.patient_id,
			p.patient_id ,
			p.insurance ,
			c.treatment,
			c.clinic_request 
		FROM Receipt r , Reception r2, Patient p , Clinic c 
		WHERE r.reception_id = r2.reception_id 
			AND r.reception_id = c.reception_id
			AND r2.patient_id = p.patient_id;
	</select>
	


</mapper>